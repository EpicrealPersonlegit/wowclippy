local AvatarEditorService = game:GetService("AvatarEditorService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")

local Player = Players.LocalPlayer
local PlayerGui = Player:WaitForChild("PlayerGui")
local EquipEvent = ReplicatedStorage:WaitForChild("EquipAssetEvent")
local ChangeSkinColorEvent = ReplicatedStorage:WaitForChild("ChangeSkinColor")

local SearchBox, ResultsFrame, SkinHexBox

-- [[ DIAGRAM: HOW THE SCRIPT FINDS YOUR UI AUTOMATICALLY ]]
-- 

print("DEBUG: Scanning for UI elements...")

-- Recursive scanner to find UI by name no matter where they are
local function scanUI()
	for _, v in pairs(PlayerGui:GetDescendants()) do
		if v.Name == "Search" and v:IsA("TextBox") then SearchBox = v end
		if v.Name == "AvatarFrame" then ResultsFrame = v end
		if v.Name == "skinhex" and v:IsA("TextBox") then SkinHexBox = v end
	end
end

-- Wait until the core UI is found
repeat 
	scanUI() 
	task.wait(1) 
until SearchBox and ResultsFrame

print("DEBUG: ✅ Found SearchBox at: " .. SearchBox:GetFullName())
print("DEBUG: ✅ Found ResultsFrame at: " .. ResultsFrame:GetFullName())

local function performSearch()
	local text = SearchBox.Text:lower()
	print("DEBUG: Searching Catalog for: " .. text)
	
	-- Clear old results
	for _, v in pairs(ResultsFrame:GetChildren()) do
		if v:IsA("ImageButton") then v:Destroy() end
	end

	-- Powerful Asset Type Support (Limbs, Dynamic Faces, Layered Clothes)
	local selectedTypes = {
		Enum.AvatarAssetType.Hat, Enum.AvatarAssetType.HairAccessory, 
		Enum.AvatarAssetType.Shirt, Enum.AvatarAssetType.Pants,
		Enum.AvatarAssetType.JacketAccessory, Enum.AvatarAssetType.ShoesAccessory,
		Enum.AvatarAssetType.DynamicHead, Enum.AvatarAssetType.LeftArm,
		Enum.AvatarAssetType.RightArm, Enum.AvatarAssetType.LeftLeg,
		Enum.AvatarAssetType.RightLeg, Enum.AvatarAssetType.Torso
	}

	local params = CatalogSearchParams.new()
	params.SearchKeyword = text
	params.AssetTypes = selectedTypes

	local success, result = pcall(function() return AvatarEditorService:SearchCatalog(params) end)
	
	if success and result then
		local items = result:GetCurrentPage()
		print("DEBUG: Search Success! Items found: " .. #items)
		for _, item in pairs(items) do
			local btn = Instance.new("ImageButton")
			btn.Name = tostring(item.Id)
			btn.Size = UDim2.new(0, 90, 0, 90)
			btn.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
			btn.Image = "rbxthumb://type=Asset&id=" .. item.Id .. "&w=150&h=150"
			btn.Parent = ResultsFrame
			
			-- Ensure there is a grid layout
			if not ResultsFrame:FindFirstChildOfClass("UIGridLayout") then
				local gl = Instance.new("UIGridLayout", ResultsFrame)
				gl.CellSize = UDim2.new(0, 90, 0, 90)
			end

			btn.MouseButton1Click:Connect(function()
				print("DEBUG: Equipping ID " .. item.Id)
				EquipEvent:FireServer(item.Id, "Equip")
			end)
		end
	else
		warn("DEBUG: Catalog API failed to return results.")
	end
end

SearchBox.FocusLost:Connect(function(enter)
	if enter then performSearch() end
end)

if SkinHexBox then
	SkinHexBox.FocusLost:Connect(function(enter)
		if enter then ChangeSkinColorEvent:FireServer(SkinHexBox.Text) end
	end)
end
