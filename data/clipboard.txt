local AvatarEditorService = game:GetService("AvatarEditorService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local EquipEvent = ReplicatedStorage:WaitForChild("EquipAssetEvent")

-- SAFETY CHECK: Ensure frames exist before indexing
local ParentUI = script.Parent
local FrameSearch = ParentUI:WaitForChild("FrameSearch", 10)
local FrameSideBar = ParentUI:WaitForChild("FrameSideBar", 10)

if not FrameSearch or not FrameSideBar then
	error("‚ùå UI Hierarchy Error: Could not find FrameSearch or FrameSideBar in script.Parent!")
end

local SearchBox = FrameSearch:WaitForChild("Search")
local ResultsFrame = FrameSearch:WaitForChild("AvatarFrame")

-- Modern Search Tags (Includes Limbs and Dynamic Clothes)
local TAG_DATA = {
	["jacket"] = {Enum.AvatarAssetType.JacketAccessory},
	["shoe"] = {Enum.AvatarAssetType.LeftShoeAccessory, Enum.AvatarAssetType.RightShoeAccessory},
	["face"] = {Enum.AvatarAssetType.Face, Enum.AvatarAssetType.DynamicHead},
	["arm"] = {Enum.AvatarAssetType.LeftArm, Enum.AvatarAssetType.RightArm},
	["leg"] = {Enum.AvatarAssetType.LeftLeg, Enum.AvatarAssetType.RightLeg},
	["bundle"] = {Enum.AvatarAssetType.Bundle}
}

local function performSearch()
	local text = SearchBox.Text:lower()
	local selectedTypes = {Enum.AvatarAssetType.Hat, Enum.AvatarAssetType.HairAccessory} -- Default
	
	for tag, types in pairs(TAG_DATA) do
		if text:find(tag) then
			selectedTypes = types
			break
		end
	end

	local params = CatalogSearchParams.new()
	params.SearchKeyword = text
	params.AssetTypes = selectedTypes

	local success, result = pcall(function() return AvatarEditorService:SearchCatalog(params) end)
	
	if success then
		for _, v in pairs(ResultsFrame:GetChildren()) do if v:IsA("ImageButton") then v:Destroy() end end
		for _, item in pairs(result:GetCurrentPage()) do
			local btn = Instance.new("ImageButton")
			btn.Size = UDim2.new(0, 100, 0, 100)
			btn.Image = "rbxthumb://type=Asset&id=" .. item.Id .. "&w=150&h=150"
			btn.Parent = ResultsFrame
			btn.MouseButton1Click:Connect(function() EquipEvent:FireServer(item.Id, "Equip") end)
		end
	end
end

SearchBox.FocusLost:Connect(function(enter) if enter then performSearch() end end)
