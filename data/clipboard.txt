-- [[ Line 1: Setup ]]
local AvatarEditorService = game:GetService("AvatarEditorService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local Player = Players.LocalPlayer
local PlayerGui = Player:WaitForChild("PlayerGui")

local SearchBox, ResultsFrame, SkinHexBox
local EquipEvent = ReplicatedStorage:WaitForChild("EquipAssetEvent")
local ChangeSkinColorEvent = ReplicatedStorage:WaitForChild("ChangeSkinColor")

-- [[ Line 12: Aggressive Scanning ]]
local function scanUI()
	for _, v in pairs(PlayerGui:GetDescendants()) do
		if v.Name == "Search" and v:IsA("TextBox") then SearchBox = v end
		if v.Name == "AvatarFrame" then ResultsFrame = v end
		if v.Name == "skinhex" and v:IsA("TextBox") then SkinHexBox = v end
	end
end

-- [[ Line 20: Wait Logic ]]
print("DEBUG: Waiting for UI to load...")
repeat scanUI(); task.wait(1) until SearchBox and ResultsFrame
print("DEBUG: UI Found! SearchBox is: " .. SearchBox:GetFullName())

-- [[ Line 25: Search Logic ]]
local function performSearch()
	local text = SearchBox.Text:lower()
	print("DEBUG: User searched for: " .. text)
	
	for _, v in pairs(ResultsFrame:GetChildren()) do
		if v:IsA("ImageButton") then v:Destroy() end
	end

	local selectedTypes = {
		Enum.AvatarAssetType.Hat, Enum.AvatarAssetType.HairAccessory, 
		Enum.AvatarAssetType.Shirt, Enum.AvatarAssetType.Pants,
		Enum.AvatarAssetType.JacketAccessory, Enum.AvatarAssetType.ShoesAccessory,
		Enum.AvatarAssetType.DynamicHead, Enum.AvatarAssetType.LeftArm,
		Enum.AvatarAssetType.RightArm, Enum.AvatarAssetType.LeftLeg,
		Enum.AvatarAssetType.RightLeg, Enum.AvatarAssetType.Torso
	}

	local params = CatalogSearchParams.new()
	params.SearchKeyword = text
	params.AssetTypes = selectedTypes

	-- [[ Line 46: The Red-Underline Service Call ]]
	local success, result = pcall(function() 
		return AvatarEditorService:SearchCatalog(params) 
	end)
	
	if success and result then
		local items = result:GetCurrentPage()
		print("DEBUG: Results found: " .. #items)
		for _, item in pairs(items) do
			local btn = Instance.new("ImageButton")
			btn.Size = UDim2.new(0, 90, 0, 90)
			btn.BackgroundColor3 = Color3.fromRGB(30,30,30)
			btn.Image = "rbxthumb://type=Asset&id=" .. item.Id .. "&w=150&h=150"
			btn.Parent = ResultsFrame
			
			btn.MouseButton1Click:Connect(function()
				EquipEvent:FireServer(item.Id, "Equip")
			end)
		end
	end
end

-- [[ Line 68: The Connection Logic (Old Line 88) ]]
-- We use a pcall here so it NEVER crashes the script
pcall(function()
	if SearchBox then
		SearchBox.FocusLost:Connect(function(enter)
			if enter then performSearch() end
		end)
		print("DEBUG: SearchBox Event Connected")
	end
	
	if SkinHexBox then
		SkinHexBox.FocusLost:Connect(function(enter)
			if enter then ChangeSkinColorEvent:FireServer(SkinHexBox.Text) end
		end)
		print("DEBUG: SkinHex Event Connected")
	end
end)
