local ReplicatedStorage = game:GetService("ReplicatedStorage")
local InsertService = game:GetService("InsertService")
local EquipEvent = ReplicatedStorage:WaitForChild("EquipAssetEvent")
local ChangeSkinColorEvent = ReplicatedStorage:WaitForChild("ChangeSkinColor")

-- Helper: Safe Hex to Color3
local function hexToColor3(hex)
	hex = hex:gsub("#", "")
	if #hex == 3 then
		hex = hex:sub(1,1):rep(2)..hex:sub(2,2):rep(2)..hex:sub(3,3):rep(2)
	end
	if #hex ~= 6 then return nil end
	
	local r = tonumber(hex:sub(1,2), 16)
	local g = tonumber(hex:sub(3,4), 16)
	local b = tonumber(hex:sub(5,6), 16)
	
	if r and g and b then
		return Color3.fromRGB(r, g, b)
	end
	return nil
end

-- Handle Skin Color
ChangeSkinColorEvent.OnServerEvent:Connect(function(player, hexColor)
	local character = player.Character or player.CharacterAdded:Wait()
	if not character then return end
	
	local color = hexToColor3(hexColor)
	local bodyColors = character:FindFirstChildOfClass("BodyColors") or Instance.new("BodyColors", character)
	
	if color then
		bodyColors.HeadColor3 = color
		bodyColors.LeftArmColor3 = color
		bodyColors.RightArmColor3 = color
		bodyColors.LeftLegColor3 = color
		bodyColors.RightLegColor3 = color
		bodyColors.TorsoColor3 = color
		print("✅ Applied Color3 to " .. player.Name)
	else
		bodyColors:Destroy() -- Resets to default
	end
end)

-- Handle Equipping
EquipEvent.OnServerEvent:Connect(function(player, assetId, action)
	local character = player.Character or player.CharacterAdded:Wait()
	if not character then return end

	if action == "Equip" then
		local success, model = pcall(function()
			return InsertService:LoadAsset(assetId)
		end)
		
		if not success or not model then
			warn("❌ Permission Error: Cannot load Asset " .. assetId .. ". Is it 'Free' or owned by the Game Owner?")
			return
		end
		
		-- Process all items inside the loaded model (Handles Packages/Bundles)
		for _, asset in pairs(model:GetChildren()) do
			asset.Name = "Catalog_" .. assetId
			
			if asset:IsA("Accessory") then
				-- Remove oldest of same type if > 5 (as per your logic)
				local count = 0
				for _, item in pairs(character:GetChildren()) do
					if item:IsA("Accessory") and item.AccessoryType == asset.AccessoryType then count += 1 end
				end
				if count >= 5 then 
					for _, item in pairs(character:GetChildren()) do 
						if item:IsA("Accessory") and item.AccessoryType == asset.AccessoryType then 
							item:Destroy() break 
						end 
					end 
				end
				asset.Parent = character
				
			elseif asset:IsA("Clothing") or asset:IsA("ShirtGraphic") then
				for _, c in pairs(character:GetChildren()) do
					if c.ClassName == asset.ClassName then c:Destroy() end
				end
				asset.Parent = character
				
			elseif asset:IsA("Decal") then
				local head = character:FindFirstChild("Head")
				if head and head:FindFirstChild("face") then head.face.Texture = asset.Texture end
				
			elseif asset:IsA("CharacterMesh") or asset:IsA("BodyColors") then
				for _, c in pairs(character:GetChildren()) do
					if c.ClassName == asset.ClassName then c:Destroy() end
				end
				asset.Parent = character
			end
		end
		model:Destroy()
		
	elseif action == "Remove" then
		for _, child in pairs(character:GetChildren()) do
			if child.Name == "Catalog_" .. assetId or (child:IsA("Accessory") and child.Name == tostring(assetId)) then
				child:Destroy()
			end
		end
		
	elseif action == "ClearAll" then
		for _, child in pairs(character:GetChildren()) do
			if child:IsA("Accessory") or child:IsA("Clothing") or child:IsA("CharacterMesh") or child:IsA("BodyColors") then
				child:Destroy()
			end
		end
		if character:FindFirstChild("Head") and character.Head:FindFirstChild("face") then
			character.Head.face.Texture = "rbxasset://textures/face.png"
		end
	end
end)
