local ReplicatedStorage = game:GetService("ReplicatedStorage")
local MarketplaceService = game:GetService("MarketplaceService")
local AssetService = game:GetService("AssetService")

local EquipEvent = ReplicatedStorage:FindFirstChild("EquipAssetEvent") or Instance.new("RemoteEvent", ReplicatedStorage)
EquipEvent.Name = "EquipAssetEvent"

local ChangeSkinColorEvent = ReplicatedStorage:FindFirstChild("ChangeSkinColor") or Instance.new("RemoteEvent", ReplicatedStorage)
ChangeSkinColorEvent.Name = "ChangeSkinColor"

-- Helper: Convert Hex to Color3
local function toColor3(hex)
	hex = hex:gsub("#","")
	local r = tonumber(hex:sub(1,2), 16)
	local g = tonumber(hex:sub(3,4), 16)
	local b = tonumber(hex:sub(5,6), 16)
	return (r and g and b) and Color3.fromRGB(r,g,b) or nil
end

-- Helper: Apply Bundle (Korblox)
local function applyBundle(hum, bundleId)
	local s, details = pcall(function() return AssetService:GetBundleDetailsAsync(bundleId) end)
	if s and details then
		local desc = hum:GetAppliedDescription()
		for _, item in pairs(details.Items) do
			if item.Type == "Asset" then
				local info = MarketplaceService:GetProductInfo(item.Id)
				if info.AssetTypeId == 27 then desc.Torso = item.Id
				elseif info.AssetTypeId == 28 then desc.RightArm = item.Id
				elseif info.AssetTypeId == 29 then desc.LeftArm = item.Id
				elseif info.AssetTypeId == 30 then desc.LeftLeg = item.Id
				elseif info.AssetTypeId == 31 then desc.RightLeg = item.Id
				end
			end
		end
		hum:ApplyDescription(desc)
	end
end

EquipEvent.OnServerEvent:Connect(function(player, assetId, action)
	local char = player.Character
	local hum = char and char:FindFirstChildOfClass("Humanoid")
	if not hum then return end
	
	if action == "ClearAll" then
		hum:ApplyDescription(Instance.new("HumanoidDescription"))
		return
	end

	local desc = hum:GetAppliedDescription()
	local s, info = pcall(function() return MarketplaceService:GetProductInfo(assetId) end)
	
	if s and info then
		if info.AssetTypeId == 37 then -- Bundle
			applyBundle(hum, assetId)
		elseif tostring(info.Name):find("Accessory") or info.AssetTypeId == 41 or info.AssetTypeId == 8 then
			local accs = desc:GetAccessories(true)
			table.insert(accs, {AssetId = assetId, Order = #accs+1, AccessoryType = Enum.AccessoryType.Unknown})
			desc:SetAccessories(accs, true)
		elseif info.AssetTypeId == 11 then desc.Shirt = assetId
		elseif info.AssetTypeId == 12 then desc.Pants = assetId
		end
		hum:ApplyDescription(desc)
	end
end)

ChangeSkinColorEvent.OnServerEvent:Connect(function(player, hex)
	local char = player.Character
	local hum = char and char:FindFirstChildOfClass("Humanoid")
	local color = toColor3(hex)
	if hum and color then
		local desc = hum:GetAppliedDescription()
		desc.HeadColor, desc.TorsoColor = color, color
		desc.LeftArmColor, desc.RightArmColor = color, color
		desc.LeftLegColor, desc.RightLegColor = color, color
		hum:ApplyDescription(desc)
	end
end)