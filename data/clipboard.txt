local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local StarterGui = game:GetService("StarterGui")
local UserInputService = game:GetService("UserInputService")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- Wait for GUIs to be cloned
local moneyGui = playerGui:WaitForChild("money")
local atmGui = playerGui:WaitForChild("atm")
local moneyLabel = moneyGui:WaitForChild("TextLabel")
local atmFrame = atmGui:WaitForChild("Frame")

-- Get ATM elements
local depositBtn = atmFrame:WaitForChild("deposit")
local withdrawBtn = atmFrame:WaitForChild("withdraw")
local transferBtn = atmFrame:WaitForChild("transfer")
local amountBox = atmFrame:WaitForChild("amount")
local playerNameBox = atmFrame:WaitForChild("playername")

-- Get remote events
local moneyRemote = ReplicatedStorage:WaitForChild("MoneyRemote")
local bankRemote = ReplicatedStorage:WaitForChild("BankRemote")

-- Player data
local playerMoney = 0
local playerBank = 0

-- Function to format money display
local function formatMoney(amount)
    if amount >= 1000 then
        return string.format("%.1fk", amount / 1000)
    else
        return tostring(amount)
    end
end

-- Function to update money display
local function updateMoneyDisplay()
    moneyLabel.Text = formatMoney(playerMoney) .. " CCRP"
end

-- Function to show notification
local function showNotification(message, isError)
    StarterGui:SetCore("ChatMakeSystemMessage", {
        Text = message;
        Color = isError and Color3.new(1, 0.2, 0.2) or Color3.new(0.2, 1, 0.2);
        Font = Enum.Font.SourceSansBold;
        FontSize = Enum.FontSize.Size18;
    })
end

-- Function to validate amount input
local function getValidAmount()
    local amount = tonumber(amountBox.Text)
    if amount and amount > 0 and amount <= 1000000 then -- Reasonable limit
        return amount
    end
    return nil
end

-- Function to validate player name
local function getValidPlayerName()
    local name = playerNameBox.Text:gsub("^%s*(.-)%s*$", "%1") -- Trim whitespace
    if name and name ~= "" and #name <= 50 then
        return name
    end
    return nil
end

-- Handle money remote events
moneyRemote.OnClientEvent:Connect(function(action, value)
    if action == "UpdateMoney" then
        playerMoney = value
        updateMoneyDisplay()
    elseif action == "UpdateBank" then
        playerBank = value
    end
end)

-- Handle bank remote events
bankRemote.OnClientEvent:Connect(function(action, message)
    if action == "Success" then
        showNotification(message, false)
        -- Clear input fields
        amountBox.Text = ""
        playerNameBox.Text = ""
    elseif action == "Error" then
        showNotification(message, true)
    end
end)

-- ATM button handlers
depositBtn.MouseButton1Click:Connect(function()
    local amount = getValidAmount()
    if amount then
        bankRemote:FireServer("Deposit", amount)
    else
        showNotification("Please enter a valid amount!", true)
    end
end)

withdrawBtn.MouseButton1Click:Connect(function()
    local amount = getValidAmount()
    if amount then
        bankRemote:FireServer("Withdraw", amount)
    else
        showNotification("Please enter a valid amount!", true)
    end
end)

transferBtn.MouseButton1Click:Connect(function()
    local amount = getValidAmount()
    local targetName = getValidPlayerName()
    
    if amount and targetName then
        bankRemote:FireServer("Transfer", amount, targetName)
    else
        if not amount then
            showNotification("Please enter a valid amount!", true)
        else
            showNotification("Please enter a valid player name!", true)
        end
    end
end)

-- Request initial data
moneyRemote:FireServer("GetMoney")
moneyRemote:FireServer("GetBank")

-- Toggle ATM visibility with key (optional - press 'E' to toggle)
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if not gameProcessed and input.KeyCode == Enum.KeyCode.E then
        atmGui.Enabled = not atmGui.Enabled
    end
end)

-- Make sure ATM is initially disabled
atmGui.Enabled = false