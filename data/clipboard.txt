local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local StarterGui = game:GetService("StarterGui")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- UI References
local atmGui = playerGui:WaitForChild("atm")
local atmFrame = atmGui:WaitForChild("Frame")
local moneyLabel = playerGui:WaitForChild("money"):WaitForChild("TextLabel")

local amountBox = atmFrame:WaitForChild("amount")
local playerNameBox = atmFrame:WaitForChild("playername")

local moneyRemote = ReplicatedStorage:WaitForChild("MoneyRemote")
local bankRemote = ReplicatedStorage:WaitForChild("BankRemote")

-- Formatting
local function formatCurrency(amount)
    if amount >= 1000000 then
        return string.format("%.1fM", amount / 1000000)
    elseif amount >= 1000 then
        return string.format("%.1fk", amount / 1000)
    end
    return tostring(amount)
end

-- Safely send system messages
local function showNotify(msg, isErr)
    local success, err = pcall(function()
        StarterGui:SetCore("ChatMakeSystemMessage", {
            Text = "[BANK]: " .. msg,
            Color = isErr and Color3.fromRGB(255, 75, 75) or Color3.fromRGB(75, 255, 75),
            Font = Enum.Font.SourceSansBold
        })
    end)
end

-- Consolidate button logic
local function handleRequest(action)
    local amt = tonumber(amountBox.Text:match("%d+")) -- Extract only digits
    local target = playerNameBox.Text
    
    if not amt or amt <= 0 then
        return showNotify("Please enter a valid positive number!", true)
    end
    
    if action == "Transfer" then
        if #target < 2 then
            return showNotify("Please enter a valid player name!", true)
        end
        bankRemote:FireServer("Transfer", amt, target)
    else
        bankRemote:FireServer(action, amt)
    end
end

-- Logic Connections
moneyRemote.OnClientEvent:Connect(function(action, val)
    if action == "UpdateMoney" then
        moneyLabel.Text = formatCurrency(val) .. " CCRP"
    end
end)

bankRemote.OnClientEvent:Connect(function(action, msg)
    showNotify(msg, action == "Error")
    if action == "Success" then
        amountBox.Text = ""
        playerNameBox.Text = ""
    end
end)

-- Event Bindings
atmFrame:WaitForChild("deposit").Activated:Connect(function() handleRequest("Deposit") end)
atmFrame:WaitForChild("withdraw").Activated:Connect(function() handleRequest("Withdraw") end)
atmFrame:WaitForChild("transfer").Activated:Connect(function() handleRequest("Transfer") end)
