local Players = game:GetService("Players")
local DataStoreService = game:GetService("DataStoreService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- Create Remotes (Ideally, do this in Studio, not code, but this works)
local MoneyRemote = Instance.new("RemoteEvent")
MoneyRemote.Name = "MoneyRemote"
MoneyRemote.Parent = ReplicatedStorage

local BankRemote = Instance.new("RemoteEvent")
BankRemote.Name = "BankRemote"
BankRemote.Parent = ReplicatedStorage

local playerDataStore = DataStoreService:GetDataStore("PlayerMoneyData")
local playerData = {}
local STARTING_MONEY = 100

-- 1. Helper Functions
local function formatMoney(amount)
	if amount >= 1000 then
		return string.format("%.1fk", amount / 1000)
	else
		return tostring(amount)
	end
end

-- 2. Define SAVE first (Fixes Scope Issue)
local function savePlayerData(player)
	local data = playerData[player.UserId]
	if not data then return end

	local success, errorMessage = pcall(function()
		playerDataStore:SetAsync(tostring(player.UserId), {
			money = data.money,
			bank = data.bank
		})
	end)

	if not success then
		warn("Failed to save data for " .. player.Name .. ": " .. tostring(errorMessage))
	end
end

-- 3. Define LOAD second
local function loadPlayerData(player)
	local success, data = pcall(function()
		return playerDataStore:GetAsync(tostring(player.UserId))
	end)

	if success and data then
		playerData[player.UserId] = {
			money = data.money or STARTING_MONEY,
			bank = data.bank or 0
		}
	else
		-- New player or load failure
		playerData[player.UserId] = {
			money = STARTING_MONEY,
			bank = 0
		}
	end
	
	-- Update Client immediately (Don't wait for character)
	MoneyRemote:FireClient(player, "UpdateMoney", playerData[player.UserId].money)
	MoneyRemote:FireClient(player, "UpdateBank", playerData[player.UserId].bank)
end

-- 4. Transaction Functions (REMOVED save calls to prevent throttling)
local function addMoney(player, amount)
	local data = playerData[player.UserId]
	if data then
		data.money += amount
		MoneyRemote:FireClient(player, "UpdateMoney", data.money)
		return true
	end
	return false
end

local function removeMoney(player, amount)
	local data = playerData[player.UserId]
	if data and data.money >= amount then
		data.money -= amount
		MoneyRemote:FireClient(player, "UpdateMoney", data.money)
		return true
	end
	return false
end

local function addToBank(player, amount)
	local data = playerData[player.UserId]
	if data then
		data.bank += amount
		MoneyRemote:FireClient(player, "UpdateBank", data.bank)
		return true
	end
	return false
end

local function removeFromBank(player, amount)
	local data = playerData[player.UserId]
	if data and data.bank >= amount then
		data.bank -= amount
		MoneyRemote:FireClient(player, "UpdateBank", data.bank)
		return true
	end
	return false
end

-- 5. Event Handlers
local function onPlayerAdded(player)
	loadPlayerData(player) -- Load immediately
end

local function onPlayerRemoving(player)
	savePlayerData(player) -- Save on exit
	playerData[player.UserId] = nil
end

Players.PlayerAdded:Connect(onPlayerAdded)
Players.PlayerRemoving:Connect(onPlayerRemoving)

-- Fix Race Condition for Studio/Late Script Load
for _, player in ipairs(Players:GetPlayers()) do
	task.spawn(function() onPlayerAdded(player) end)
end

-- Remote Logic
BankRemote.OnServerEvent:Connect(function(player, action, amount, targetName)
	if not playerData[player.UserId] then return end
	
	amount = tonumber(amount)
	
	-- SECURITY: Server-side validation limit
	if not amount or amount <= 0 or amount > 1000000 or amount % 1 ~= 0 then
		BankRemote:FireClient(player, "Error", "Invalid amount!")
		return
	end

	if action == "Deposit" then
		if removeMoney(player, amount) then
			addToBank(player, amount)
			BankRemote:FireClient(player, "Success", "Deposited " .. formatMoney(amount))
		else
			BankRemote:FireClient(player, "Error", "Insufficient funds!")
		end
	elseif action == "Withdraw" then
		if removeFromBank(player, amount) then
			addMoney(player, amount)
			BankRemote:FireClient(player, "Success", "Withdrew " .. formatMoney(amount))
		else
			BankRemote:FireClient(player, "Error", "Insufficient bank funds!")
		end
	elseif action == "Transfer" then
		local target = Players:FindFirstChild(targetName)
		if target and target ~= player and playerData[target.UserId] then
			if removeFromBank(player, amount) then
				addToBank(target, amount)
				BankRemote:FireClient(player, "Success", "Transferred to " .. target.Name)
			else
				BankRemote:FireClient(player, "Error", "Insufficient funds!")
			end
		else
			BankRemote:FireClient(player, "Error", "Player not found!")
		end
	end
end)

-- Autosave loop
task.spawn(function()
	while true do
		task.wait(60)
		for _, player in ipairs(Players:GetPlayers()) do
			savePlayerData(player)
		end
	end
end)

game:BindToClose(function()
	for _, player in ipairs(Players:GetPlayers()) do
		savePlayerData(player)
	end
end)
