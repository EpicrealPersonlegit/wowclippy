local AvatarEditorService = game:GetService("AvatarEditorService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")

local Player = Players.LocalPlayer
local PlayerGui = Player:WaitForChild("PlayerGui")
local EquipEvent = ReplicatedStorage:WaitForChild("EquipAssetEvent")
local ChangeSkinColorEvent = ReplicatedStorage:WaitForChild("ChangeSkinColor")

-- [[ UI HIERARCHY ]]
local MainGui = PlayerGui:WaitForChild("Avatar")
local FrameSearch = MainGui:WaitForChild("FrameSearch")
local FrameSideBar = MainGui:WaitForChild("FrameSideBar")

local SearchBox = FrameSearch:WaitForChild("Search")
local ResultsFrame = FrameSearch:WaitForChild("AvatarFrame")

-- Sidebar (Your specific names)
local StringsBox = FrameSideBar:WaitForChild("Strings")
local ApplyBtn = FrameSideBar:WaitForChild("Apply")
local ClearABtn = FrameSideBar:WaitForChild("ClearA")
local SkinHexBox = FrameSideBar:WaitForChild("skinhex")

-- [[ SEARCH LOGIC ]]
local function performSearch()
	local text = SearchBox.Text
	if text == "" then return end
	
	for _, v in pairs(ResultsFrame:GetChildren()) do
		if v:IsA("ImageButton") then v:Destroy() end
	end

	local params = CatalogSearchParams.new()
	params.SearchKeyword = text
	-- Valid Enums for modern Roblox
	params.AssetTypes = {
		Enum.AvatarAssetType.Hat, Enum.AvatarAssetType.HairAccessory,
		Enum.AvatarAssetType.Shirt, Enum.AvatarAssetType.Pants,
		Enum.AvatarAssetType.Shoes, Enum.AvatarAssetType.Jacket
	}
	
	local success, result = pcall(function() 
		return AvatarEditorService:SearchCatalog(params) 
	end)
	
	if success and result then
		if not ResultsFrame:FindFirstChildOfClass("UIGridLayout") then
			local gl = Instance.new("UIGridLayout", ResultsFrame)
			gl.CellSize = UDim2.new(0, 90, 0, 90)
		end

		for _, item in pairs(result:GetCurrentPage()) do
			local btn = Instance.new("ImageButton")
			btn.Name = tostring(item.Id)
			btn.Size = UDim2.new(0, 90, 0, 90)
			btn.Image = "rbxthumb://type=Asset&id=" .. item.Id .. "&w=150&h=150"
			btn.Parent = ResultsFrame
			btn.MouseButton1Click:Connect(function()
				EquipEvent:FireServer(item.Id, "Equip")
			end)
		end
	end
end

-- [[ CONNECTIONS ]]
ApplyBtn.MouseButton1Click:Connect(function()
	local code = StringsBox.Text
	if code ~= "" then
		local id = tonumber(code, 36)
		if id then EquipEvent:FireServer(id, "Equip") end
	end
end)

ClearABtn.MouseButton1Click:Connect(function()
	EquipEvent:FireServer(nil, "ClearAll")
end)

SkinHexBox.FocusLost:Connect(function(enter)
	if SkinHexBox.Text ~= "" then
		ChangeSkinColorEvent:FireServer(SkinHexBox.Text)
	end
end)

SearchBox.FocusLost:Connect(function(enter)
	if enter then performSearch() end
end)