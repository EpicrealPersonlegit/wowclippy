local AvatarEditorService = game:GetService("AvatarEditorService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local EquipEvent = ReplicatedStorage:WaitForChild("EquipAssetEvent")
local SearchBox = script.Parent:WaitForChild("FrameSearch"):WaitForChild("Search")
local ResultsFrame = script.Parent:WaitForChild("FrameSearch"):WaitForChild("AvatarFrame")

-- Extended Tag Mapping for Modern Assets
local TAGS = {
	["jacket"] = {Enum.AvatarAssetType.JacketAccessory},
	["sweater"] = {Enum.AvatarAssetType.SweaterAccessory},
	["shoes"] = {Enum.AvatarAssetType.ShoesAccessory},
	["pants"] = {Enum.AvatarAssetType.Pants, Enum.AvatarAssetType.BottomAccessory},
	["shirt"] = {Enum.AvatarAssetType.Shirt, Enum.AvatarAssetType.ShirtAccessory},
	["hair"] = {Enum.AvatarAssetType.HairAccessory},
	["face"] = {Enum.AvatarAssetType.Face, Enum.AvatarAssetType.DynamicHead},
	["arm"] = {Enum.AvatarAssetType.LeftArm, Enum.AvatarAssetType.RightArm},
	["leg"] = {Enum.AvatarAssetType.LeftLeg, Enum.AvatarAssetType.RightLeg},
	["torso"] = {Enum.AvatarAssetType.Torso},
	["bundle"] = {Enum.AvatarAssetType.Bundle}
}

local function performSearch()
	local text = SearchBox.Text:lower()
	local selectedTypes = {}
	local cleanedQuery = text
	
	-- Extract tags
	for tag, enums in pairs(TAGS) do
		if text:find(tag) then
			for _, e in pairs(enums) do table.insert(selectedTypes, e) end
			cleanedQuery = cleanedQuery:gsub(tag, "")
		end
	end
	
	-- Fallback if no tags
	if #selectedTypes == 0 then
		selectedTypes = {Enum.AvatarAssetType.Hat, Enum.AvatarAssetType.Shirt, Enum.AvatarAssetType.Pants}
	end

	local params = CatalogSearchParams.new()
	params.SearchKeyword = cleanedQuery:match("^%s*(.-)%s*$")
	params.AssetTypes = selectedTypes

	local success, result = pcall(function() return AvatarEditorService:SearchCatalog(params) end)
	
	if success then
		for _, v in pairs(ResultsFrame:GetChildren()) do if v:IsA("ImageButton") then v:Destroy() end end
		
		for _, item in pairs(result:GetCurrentPage()) do
			local btn = Instance.new("ImageButton")
			btn.Name = tostring(item.Id)
			btn.Size = UDim2.new(0, 100, 0, 100)
			btn.Image = "rbxthumb://type=Asset&id=" .. item.Id .. "&w=150&h=150"
			btn.Parent = ResultsFrame
			btn.MouseButton1Click:Connect(function()
				EquipEvent:FireServer(item.Id, "Equip")
			end)
		end
	end
end

SearchBox.FocusLost:Connect(function(enter) if enter then performSearch() end end)
