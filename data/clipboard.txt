print("DEBUG SERVER: Starting Avatar Engine...")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local MarketplaceService = game:GetService("MarketplaceService")
local EquipEvent = ReplicatedStorage:WaitForChild("EquipAssetEvent")

local ASSET_MAP = {
    [8] = "Hat", [11] = "Shirt", [12] = "Pants", [18] = "Face",
    [27] = "Torso", [28] = "RightArm", [29] = "LeftArm", [30] = "LeftLeg", [31] = "RightLeg",
    [41] = "HairAccessory", [42] = "FaceAccessory", [43] = "NeckAccessory",
    [44] = "ShoulderAccessory", [45] = "FrontAccessory", [46] = "BackAccessory", [47] = "WaistAccessory",
    [64] = "JacketAccessory", [65] = "SweaterAccessory", [66] = "ShortsAccessory",
    [67] = "LeftShoeAccessory", [68] = "RightShoeAccessory"
}

EquipEvent.OnServerEvent:Connect(function(player, assetId, action)
    print("DEBUG SERVER: Received Event from " .. player.Name .. " | Action: " .. action .. " | ID: " .. tostring(assetId))
    
    local character = player.Character
    local humanoid = character and character:FindFirstChildOfClass("Humanoid")
    if not humanoid then 
        warn("DEBUG SERVER: No Humanoid found for " .. player.Name)
        return 
    end

    local description = humanoid:GetAppliedDescription()

    if action == "Equip" then
        print("DEBUG SERVER: Fetching info for Asset " .. assetId)
        local success, info = pcall(function() return MarketplaceService:GetProductInfo(assetId) end)
        
        if success and info then
            local typeId = info.AssetTypeId
            local prop = ASSET_MAP[typeId]
            print("DEBUG SERVER: Asset Type " .. typeId .. " maps to: " .. tostring(prop))

            if prop then
                if prop:find("Accessory") then
                    local accs = description:GetAccessories(true)
                    table.insert(accs, {AssetId = assetId, Order = #accs + 1, AccessoryType = Enum.AccessoryType.Unknown})
                    description:SetAccessories(accs, true)
                    print("DEBUG SERVER: Added Accessory to Description.")
                else
                    description[prop] = assetId
                    print("DEBUG SERVER: Updated Property " .. prop .. " to ID " .. assetId)
                end
                
                local applySuccess, err = pcall(function() humanoid:ApplyDescription(description) end)
                if applySuccess then
                    print("DEBUG SERVER: Applied successfully to " .. player.Name)
                else
                    warn("DEBUG SERVER ERROR: " .. err)
                end
            end
        else
            warn("DEBUG SERVER: Failed to fetch Marketplace info.")
        end
    end
end)
