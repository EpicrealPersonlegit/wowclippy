local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")

-- 1. Configuration
local IDLE_OFFSET = Vector3.new(0, 2.5, 0)
local WALK_OFFSET = Vector3.new(0, 1.5, 0)
local IDLE_TRANSPARENCY = 0.3
local WALK_TRANSPARENCY = 0.9
local TWEEN_TIME = 0.4 -- Slightly faster feel

local NAME_TAG_TEMPLATE = ReplicatedStorage:WaitForChild("NameAndDescTag", 5)

local TWEEN_INFO = TweenInfo.new(
	TWEEN_TIME,
	Enum.EasingStyle.Quad,
	Enum.EasingDirection.Out
)

-- 2. Helper to manage Tweens (Prevents memory bloat)
local function applyState(billboardGui, isWalking)
	local targetTransparency = isWalking and WALK_TRANSPARENCY or IDLE_TRANSPARENCY
	local targetOffset = isWalking and WALK_OFFSET or IDLE_OFFSET

	-- Tween the BillboardGui itself
	TweenService:Create(billboardGui, TWEEN_INFO, {StudsOffset = targetOffset}):Play()

	-- Batch tween all text elements
	for _, child in ipairs(billboardGui:GetDescendants()) do
		if child:IsA("TextLabel") then
			TweenService:Create(child, TWEEN_INFO, {
				TextTransparency = targetTransparency,
				TextStrokeTransparency = (targetTransparency >= 0.9) and 1 or 0.8
			}):Play()
		end
	end
end

-- 3. Setup Logic
local function setupNameTag(player, character)
	local head = character:WaitForChild("Head", 10)
	local humanoid = character:WaitForChild("Humanoid", 10)
	if not head or not humanoid then return end

	-- Cleanup existing
	local existing = head:FindFirstChild("NameAndDescTag")
	if existing then existing:Destroy() end

	-- Clone Template (Assuming Template is the BillboardGui itself now)
	-- If your template is still a Part, change it to just the BillboardGui for efficiency.
	local billboardGui = NAME_TAG_TEMPLATE:Clone()
	billboardGui.Name = "NameAndDescTag"
	billboardGui.Adornee = head
	billboardGui.Parent = head
	billboardGui.StudsOffset = IDLE_OFFSET

	-- Set Name
	local nameLabel = billboardGui:FindFirstChild("originalName", true) -- Recursive find
	if nameLabel then
		nameLabel.Text = "@" .. player.Name
	end

	-- EVENT-DRIVEN Movement Monitoring
	local isWalking = false
	
	-- Connection cleanup on character death/removal
	local runningConnection
	runningConnection = humanoid.Running:Connect(function(speed)
		if not billboardGui or not billboardGui.Parent then
			runningConnection:Disconnect()
			return
		end

		local nowWalking = speed > 0.5
		if nowWalking ~= isWalking then
			isWalking = nowWalking
			applyState(billboardGui, isWalking)
		end
	end)
end

-- 4. Initialization
local function onPlayerAdded(player)
	player.CharacterAdded:Connect(function(character)
		setupNameTag(player, character)
	end)

	if player.Character then
		task.spawn(setupNameTag, player, player.Character)
	end
end

Players.PlayerAdded:Connect(onPlayerAdded)
for _, player in ipairs(Players:GetPlayers()) do
	onPlayerAdded(player)
end
