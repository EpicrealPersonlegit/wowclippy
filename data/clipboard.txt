local ReplicatedStorage = game:GetService("ReplicatedStorage")
local MarketplaceService = game:GetService("MarketplaceService")
local AssetService = game:GetService("AssetService")

local EquipEvent = ReplicatedStorage:FindFirstChild("EquipAssetEvent") or Instance.new("RemoteEvent", ReplicatedStorage)
EquipEvent.Name = "EquipAssetEvent"
local SkinEvent = ReplicatedStorage:FindFirstChild("ChangeSkinColor") or Instance.new("RemoteEvent", ReplicatedStorage)
SkinEvent.Name = "ChangeSkinColor"

local function applyBundle(hum, id)
    local s, res = pcall(function() return AssetService:GetBundleDetailsAsync(id) end)
    if s and res then
        local d = hum:GetAppliedDescription()
        for _, v in pairs(res.Items) do
            if v.Type == "Asset" then
                local i = MarketplaceService:GetProductInfo(v.Id)
                if i.AssetTypeId == 27 then d.Torso = v.Id
                elseif i.AssetTypeId == 28 then d.RightArm = v.Id
                elseif i.AssetTypeId == 29 then d.LeftArm = v.Id
                elseif i.AssetTypeId == 30 then d.LeftLeg = v.Id
                elseif i.AssetTypeId == 31 then d.RightLeg = v.Id
                end
            end
        end
        hum:ApplyDescription(d)
    end
end

EquipEvent.OnServerEvent:Connect(function(plr, id, action)
    local hum = plr.Character and plr.Character:FindFirstChildOfClass("Humanoid")
    if not hum then return end
    if action == "ClearAll" then hum:ApplyDescription(Instance.new("HumanoidDescription")) return end

    local s, info = pcall(function() return MarketplaceService:GetProductInfo(id) end)
    if s and info then
        local d = hum:GetAppliedDescription()
        if info.AssetTypeId == 37 then applyBundle(hum, id)
        elseif info.AssetTypeId == 11 then d.Shirt = id
        elseif info.AssetTypeId == 12 then d.Pants = id
        else
            local accs = d:GetAccessories(true)
            table.insert(accs, {AssetId = id, Order = #accs+1, AccessoryType = Enum.AccessoryType.Unknown})
            d:SetAccessories(accs, true)
        end
        hum:ApplyDescription(d)
    end
end)

SkinEvent.OnServerEvent:Connect(function(plr, hex)
    local hum = plr.Character and plr.Character:FindFirstChildOfClass("Humanoid")
    if not hum then return end
    hex = hex:gsub("#","")
    local r, g, b = tonumber(hex:sub(1,2), 16), tonumber(hex:sub(3,4), 16), tonumber(hex:sub(5,6), 16)
    if r and g and b then
        local d = hum:GetAppliedDescription()
        local c = Color3.fromRGB(r,g,b)
        d.HeadColor, d.TorsoColor, d.LeftArmColor, d.RightArmColor, d.LeftLegColor, d.RightLegColor = c, c, c, c, c, c
        hum:ApplyDescription(d)
    end
end)