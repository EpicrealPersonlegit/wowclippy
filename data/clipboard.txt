local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local StarterGui = game:GetService("StarterGui")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- UI References (Wrapped in a pcall or checks for safety)
local atmGui = playerGui:WaitForChild("atm")
local atmFrame = atmGui:WaitForChild("Frame")
local moneyLabel = playerGui:WaitForChild("money"):WaitForChild("TextLabel")

local depositBtn = atmFrame:WaitForChild("deposit")
local withdrawBtn = atmFrame:WaitForChild("withdraw")
local transferBtn = atmFrame:WaitForChild("transfer")
local amountBox = atmFrame:WaitForChild("amount")
local playerNameBox = atmFrame:WaitForChild("playername")

local moneyRemote = ReplicatedStorage:WaitForChild("MoneyRemote")
local bankRemote = ReplicatedStorage:WaitForChild("BankRemote")

-- Formatting
local function formatCurrency(amount)
	return amount >= 1000 and string.format("%.1fk", amount / 1000) or tostring(amount)
end

local function showNotify(msg, isErr)
	StarterGui:SetCore("ChatMakeSystemMessage", {
		Text = "[BANK]: " .. msg,
		Color = isErr and Color3.new(1, 0.3, 0.3) or Color3.new(0.3, 1, 0.3),
		Font = Enum.Font.SourceSansBold
	})
end

-- Logic
moneyRemote.OnClientEvent:Connect(function(action, val)
	if action == "UpdateMoney" then
		moneyLabel.Text = formatCurrency(val) .. " CCRP"
	end
end)

bankRemote.OnClientEvent:Connect(function(action, msg)
	showNotify(msg, action == "Error")
	if action == "Success" then
		amountBox.Text = ""
		playerNameBox.Text = ""
	end
end)

depositBtn.MouseButton1Click:Connect(function()
	local amt = tonumber(amountBox.Text)
	if amt and amt > 0 then
		bankRemote:FireServer("Deposit", amt)
	else
		showNotify("Enter a valid amount!", true)
	end
end)

withdrawBtn.MouseButton1Click:Connect(function()
	local amt = tonumber(amountBox.Text)
	if amt and amt > 0 then
		bankRemote:FireServer("Withdraw", amt)
	else
		showNotify("Enter a valid amount!", true)
	end
end)

transferBtn.MouseButton1Click:Connect(function()
	local amt = tonumber(amountBox.Text)
	local target = playerNameBox.Text
	if amt and amt > 0 and #target > 0 then
		bankRemote:FireServer("Transfer", amt, target)
	else
		showNotify("Fill in amount and player name!", true)
	end
end)
