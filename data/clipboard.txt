print("DEBUG: Script Starting...")
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local AvatarEditorService = game:GetService("AvatarEditorService")

local Player = Players.LocalPlayer
local PlayerGui = Player:WaitForChild("PlayerGui")

-- Helper to find a child even if it's nested deep
local function findDeepChild(parent, name)
	local child = parent:FindFirstChild(name, true) -- The 'true' makes it recursive
	return child
end

print("DEBUG: Waiting for ScreenGui 'Avatar'...")
local MainGui = PlayerGui:WaitForChild("Avatar", 10)

if not MainGui then
	error("DEBUG FATAL: ScreenGui 'Avatar' not found in PlayerGui! Is it named exactly 'Avatar'?")
end

print("DEBUG: Looking for FrameSearch recursively...")
local FrameSearch = findDeepChild(MainGui, "FrameSearch")

if not FrameSearch then
	-- This will print EVERY child name so we can see what the script sees
	warn("DEBUG ERROR: FrameSearch not found. Current children of " .. MainGui.Name .. ":")
	for _, child in pairs(MainGui:GetDescendants()) do
		print(" - Found: " .. child.Name .. " (Class: " .. child.ClassName .. ")")
	end
	return
end

print("DEBUG: Success! Found FrameSearch at path: " .. FrameSearch:GetFullName())

local SearchBox = findDeepChild(FrameSearch, "Search")
local ResultsFrame = findDeepChild(FrameSearch, "AvatarFrame")
local EquipEvent = ReplicatedStorage:WaitForChild("EquipAssetEvent")

print("DEBUG: Elements ready. SearchBox: " .. tostring(SearchBox ~= nil))

-- [Diagram of recursive search vs standard search in Roblox hierarchy]
-- 

local function performSearch()
	print("DEBUG: performSearch started for: " .. SearchBox.Text)
	local text = SearchBox.Text:lower()
	
	-- Clear old buttons
	for _, v in pairs(ResultsFrame:GetChildren()) do
		if v:IsA("ImageButton") then v:Destroy() end
	end

	local params = CatalogSearchParams.new()
	params.SearchKeyword = text
	params.AssetTypes = {Enum.AvatarAssetType.Hat, Enum.AvatarAssetType.Shirt, Enum.AvatarAssetType.Pants, Enum.AvatarAssetType.JacketAccessory}

	local success, result = pcall(function() return AvatarEditorService:SearchCatalog(params) end)
	
	if success and result then
		local items = result:GetCurrentPage()
		print("DEBUG: Found " .. #items .. " items.")
		for _, item in pairs(items) do
			local btn = Instance.new("ImageButton")
			btn.Size = UDim2.new(0, 90, 0, 90)
			btn.Image = "rbxthumb://type=Asset&id=" .. item.Id .. "&w=150&h=150"
			btn.Parent = ResultsFrame
			btn.MouseButton1Click:Connect(function()
				print("DEBUG: Firing Equip for ID: " .. item.Id)
				EquipEvent:FireServer(item.Id, "Equip")
			end)
		end
	else
		warn("DEBUG: Catalog API Error")
	end
end

if SearchBox then
	SearchBox.FocusLost:Connect(function(enter)
		if enter then performSearch() end
	end)
end
