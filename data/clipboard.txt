local AvatarEditorService = game:GetService("AvatarEditorService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")

local Player = Players.LocalPlayer
local PlayerGui = Player:WaitForChild("PlayerGui")
local EquipEvent = ReplicatedStorage:WaitForChild("EquipAssetEvent")

local SearchBox, ResultsFrame
local EquippedItems = {} -- Track what we are wearing locally

local function scanUI()
	for _, v in pairs(PlayerGui:GetDescendants()) do
		if v.Name == "Search" and v:IsA("TextBox") then SearchBox = v end
		if v.Name == "AvatarFrame" then ResultsFrame = v end
	end
end

repeat scanUI(); task.wait(1) until SearchBox and ResultsFrame

local function performSearch()
	local text = SearchBox.Text
	if text == "" then return end
	
	for _, v in pairs(ResultsFrame:GetChildren()) do
		if v:IsA("ImageButton") then v:Destroy() end
	end

	local params = CatalogSearchParams.new()
	params.SearchKeyword = text

	local success, result = pcall(function() return AvatarEditorService:SearchCatalog(params) end)
	
	if success and result then
		for _, item in pairs(result:GetCurrentPage()) do
			local btn = Instance.new("ImageButton")
			btn.Name = tostring(item.Id)
			btn.Size = UDim2.new(0, 90, 0, 90)
			btn.Image = "rbxthumb://type=Asset&id=" .. item.Id .. "&w=150&h=150"
			btn.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
			btn.Parent = ResultsFrame
			
			-- THE TOGGLE STROKE
			local stroke = Instance.new("UIStroke")
			stroke.Thickness = 3
			stroke.Color = Color3.fromRGB(0, 255, 100) -- Green for equipped
			stroke.Enabled = EquippedItems[item.Id] or false
			stroke.Parent = btn

			btn.MouseButton1Click:Connect(function()
				if EquippedItems[item.Id] then
					-- UNWEAR
					EquippedItems[item.Id] = nil
					stroke.Enabled = false
					EquipEvent:FireServer(item.Id, "Unequip")
					print("DEBUG: Sent Unequip for " .. item.Id)
				else
					-- WEAR
					EquippedItems[item.Id] = true
					stroke.Enabled = true
					EquipEvent:FireServer(item.Id, "Equip")
					print("DEBUG: Sent Equip for " .. item.Id)
				end
			end)
		end
	end
end

SearchBox.FocusLost:Connect(function(enter) if enter then performSearch() end end)
