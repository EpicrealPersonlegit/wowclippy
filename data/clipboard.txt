local AvatarEditorService = game:GetService("AvatarEditorService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")

local Player = Players.LocalPlayer
local PlayerGui = Player:WaitForChild("PlayerGui")
local EquipEvent = ReplicatedStorage:WaitForChild("EquipAssetEvent")

local SearchBox, ResultsFrame

-- 1. Scan for UI (Finds your Search box and ScrollingFrame)
local function scanUI()
	for _, v in pairs(PlayerGui:GetDescendants()) do
		if v.Name == "Search" and v:IsA("TextBox") then SearchBox = v end
		if v.Name == "AvatarFrame" then ResultsFrame = v end
	end
end

repeat scanUI(); task.wait(1) until SearchBox and ResultsFrame
print("DEBUG: UI Found! Elements linked.")

-- 2. The Search Function (Built to never crash)
local function performSearch()
	local text = SearchBox.Text
	if text == "" then return end
	print("DEBUG: Starting Search for: " .. text)
	
	-- Clear old results safely
	for _, v in pairs(ResultsFrame:GetChildren()) do
		if v:IsA("ImageButton") then v:Destroy() end
	end

	-- We try the most stable, basic types first
	local params = CatalogSearchParams.new()
	params.SearchKeyword = text
	
	-- This pcall block prevents the Line 39/49 crash entirely
	local success, result = pcall(function() 
		-- If setting specific types fails, we just don't set them (searches all)
		pcall(function() 
			params.AssetTypes = {
				Enum.AvatarAssetType.Hat, 
				Enum.AvatarAssetType.Shirt, 
				Enum.AvatarAssetType.Pants,
				Enum.AvatarAssetType.HairAccessory
			}
		end)
		
		return AvatarEditorService:SearchCatalog(params) 
	end)
	
	if success and result then
		local items = result:GetCurrentPage()
		print("DEBUG: Found " .. #items .. " items!")
		
		-- Ensure buttons are organized
		local layout = ResultsFrame:FindFirstChildOfClass("UIGridLayout")
		if not layout then
			layout = Instance.new("UIGridLayout", ResultsFrame)
			layout.CellSize = UDim2.new(0, 90, 0, 90)
		end

		for _, item in pairs(items) do
			local btn = Instance.new("ImageButton")
			btn.Size = UDim2.new(0, 90, 0, 90)
			btn.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
			btn.Image = "rbxthumb://type=Asset&id=" .. item.Id .. "&w=150&h=150"
			btn.Parent = ResultsFrame
			
			btn.MouseButton1Click:Connect(function()
				print("DEBUG: Fire Equip for " .. item.Id)
				EquipEvent:FireServer(item.Id, "Equip")
			end)
		end
		
		-- AUTO-RESIZE: This makes the ScrollingFrame actually scrollable
		ResultsFrame.CanvasSize = UDim2.new(0, 0, 0, layout.AbsoluteContentSize.Y + 20)
	else
		warn("DEBUG: Catalog Search Failed. Service might be throttled.")
	end
end

-- 3. The Enter Connection
SearchBox.FocusLost:Connect(function(enter)
	if enter then performSearch() end
end)
