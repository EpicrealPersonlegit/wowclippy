local Players = game:GetService("Players")
local DataStoreService = game:GetService("DataStoreService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- Setup Remotes
local MoneyRemote = ReplicatedStorage:FindFirstChild("MoneyRemote") or Instance.new("RemoteEvent")
MoneyRemote.Name = "MoneyRemote"
MoneyRemote.Parent = ReplicatedStorage

local BankRemote = ReplicatedStorage:FindFirstChild("BankRemote") or Instance.new("RemoteEvent")
BankRemote.Name = "BankRemote"
BankRemote.Parent = ReplicatedStorage

local playerDataStore = DataStoreService:GetDataStore("PlayerMoneyData_v1")
local playerData = {}
local STARTING_MONEY = 100
local MAX_TRANSACTION = 1000000 -- Security cap

-- 1. Helper: Save Data (Defined BEFORE load to avoid nil errors)
local function savePlayerData(player)
	local data = playerData[player.UserId]
	if not data then return end

	local success, err = pcall(function()
		playerDataStore:SetAsync(tostring(player.UserId), {
			money = data.money,
			bank = data.bank
		})
	end)
	if not success then warn("DataStore Save Error: " .. err) end
end

-- 2. Helper: Load Data
local function loadPlayerData(player)
	local success, data = pcall(function()
		return playerDataStore:GetAsync(tostring(player.UserId))
	end)

	if success and data then
		playerData[player.UserId] = {
			money = data.money or STARTING_MONEY,
			bank = data.bank or 0
		}
	else
		playerData[player.UserId] = {money = STARTING_MONEY, bank = 0}
	end

	-- Initial sync to client
	MoneyRemote:FireClient(player, "UpdateMoney", playerData[player.UserId].money)
	MoneyRemote:FireClient(player, "UpdateBank", playerData[player.UserId].bank)
end

-- 3. Connection Handlers
Players.PlayerAdded:Connect(loadPlayerData)
Players.PlayerRemoving:Connect(onPlayerRemoving)

-- Fix for Studio/Late Starts
for _, p in ipairs(Players:GetPlayers()) do 
	task.spawn(loadPlayerData, p) 
end

-- 4. Bank Logic
BankRemote.OnServerEvent:Connect(function(player, action, amount, targetName)
	local data = playerData[player.UserId]
	if not data then return end

	amount = tonumber(amount)
	-- SECURITY: Check for negatives, non-numbers, or ridiculous amounts
	if not amount or amount <= 0 or amount > MAX_TRANSACTION or amount % 1 ~= 0 then
		BankRemote:FireClient(player, "Error", "Invalid Amount!")
		return
	end

	if action == "Deposit" then
		if data.money >= amount then
			data.money -= amount
			data.bank += amount
			MoneyRemote:FireClient(player, "UpdateMoney", data.money)
			MoneyRemote:FireClient(player, "UpdateBank", data.bank)
			BankRemote:FireClient(player, "Success", "Deposited $" .. amount)
		else
			BankRemote:FireClient(player, "Error", "Not enough cash!")
		end

	elseif action == "Withdraw" then
		if data.bank >= amount then
			data.bank -= amount
			data.money += amount
			MoneyRemote:FireClient(player, "UpdateMoney", data.money)
			MoneyRemote:FireClient(player, "UpdateBank", data.bank)
			BankRemote:FireClient(player, "Success", "Withdrew $" .. amount)
		else
			BankRemote:FireClient(player, "Error", "Not enough in bank!")
		end

	elseif action == "Transfer" then
		local target = Players:FindFirstChild(targetName)
		if target and target ~= player and playerData[target.UserId] then
			if data.bank >= amount then
				data.bank -= amount
				playerData[target.UserId].bank += amount
				
				-- Notify both players
				MoneyRemote:FireClient(player, "UpdateBank", data.bank)
				MoneyRemote:FireClient(target, "UpdateBank", playerData[target.UserId].bank)
				BankRemote:FireClient(player, "Success", "Sent to " .. target.Name)
			else
				BankRemote:FireClient(player, "Error", "Insufficient bank funds!")
			end
		else
			BankRemote:FireClient(player, "Error", "Player not found!")
		end
	end
end)

-- Autosave loop (Every 2 minutes)
task.spawn(function()
	while true do
		task.wait(120)
		for _, p in ipairs(Players:GetPlayers()) do savePlayerData(p) end
	end
end)

game:BindToClose(function()
	for _, p in ipairs(Players:GetPlayers()) do savePlayerData(p) end
end)
