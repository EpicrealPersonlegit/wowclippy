local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local ServerScriptService = game:GetService("ServerScriptService")

--// MODULES
local ProfileService = require(ServerScriptService:WaitForChild("ProfileService"))

--// CONFIGURATION
local DATA_VERSION = "PlayerMoneyData_v3" 
local STARTING_MONEY = 100
local MAX_TRANSACTION = 1000000

local ProfileTemplate = {
	Money = STARTING_MONEY, -- Cash on hand
	Bank = 0,               -- Money in ATM
}

local ProfileStore = ProfileService.GetProfileStore(DATA_VERSION, ProfileTemplate)
local Profiles = {} 

--// REMOTES
local MoneyRemote = ReplicatedStorage:FindFirstChild("MoneyRemote") or Instance.new("RemoteEvent")
MoneyRemote.Name = "MoneyRemote"
MoneyRemote.Parent = ReplicatedStorage

local BankRemote = ReplicatedStorage:FindFirstChild("BankRemote") or Instance.new("RemoteEvent")
BankRemote.Name = "BankRemote"
BankRemote.Parent = ReplicatedStorage

--// HELPER: Update Client UI
local function syncStats(player)
	local profile = Profiles[player]
	if profile then
		-- Update HUD (Cash)
		MoneyRemote:FireClient(player, "UpdateMoney", profile.Data.Money)
		-- Update ATM Display (Bank)
		MoneyRemote:FireClient(player, "UpdateBank", profile.Data.Bank)
	end
end

--// DATA LOADING
local function PlayerAdded(player)
	local profile = ProfileStore:LoadProfileAsync("Player_" .. player.UserId)
	if profile ~= nil then
		profile:AddUserId(player.UserId)
		profile:Reconcile()
		profile:ListenToRelease(function()
			Profiles[player] = nil
			player:Kick("Data session ended.")
		end)
		if player:IsDescendantOf(Players) then
			Profiles[player] = profile
			syncStats(player)
		else
			profile:Release()
		end
	else
		player:Kick("Data failed to load.")
	end
end

--// BANK LOGIC
BankRemote.OnServerEvent:Connect(function(player, action, amount, targetName)
	local profile = Profiles[player]
	if not profile then return end
	
	amount = tonumber(amount)
	if not amount or amount <= 0 or amount > MAX_TRANSACTION or amount % 1 ~= 0 then
		BankRemote:FireClient(player, "Error", "Invalid amount!")
		return
	end

	if action == "Deposit" then
		if profile.Data.Money >= amount then
			profile.Data.Money -= amount
			profile.Data.Bank += amount
			syncStats(player)
			BankRemote:FireClient(player, "Success", "Deposited $" .. amount)
		else
			BankRemote:FireClient(player, "Error", "Not enough cash!")
		end

	elseif action == "Withdraw" then
		if profile.Data.Bank >= amount then
			profile.Data.Bank -= amount
			profile.Data.Money += amount
			syncStats(player)
			BankRemote:FireClient(player, "Success", "Withdrew $" .. amount)
		else
			BankRemote:FireClient(player, "Error", "Not enough in bank!")
		end

	elseif action == "Transfer" then
		local target = Players:FindFirstChild(targetName)
		if target and target ~= player then
			local targetProfile = Profiles[target]
			if targetProfile then
				if profile.Data.Bank >= amount then
					-- Subtract from sender
					profile.Data.Bank -= amount
					-- Add to receiver
					targetProfile.Data.Bank += amount
					
					-- Update both players
					syncStats(player)
					syncStats(target)
					
					BankRemote:FireClient(player, "Success", "Sent $"..amount.." to "..target.Name)
					BankRemote:FireClient(target, "Success", "Received $"..amount.." from "..player.Name)
				else
					BankRemote:FireClient(player, "Error", "Insufficient bank funds!")
				end
			else
				BankRemote:FireClient(player, "Error", "Target's data not loaded.")
			end
		else
			BankRemote:FireClient(player, "Error", "Player not found or invalid.")
		end
	end
end)

--// INIT
Players.PlayerAdded:Connect(PlayerAdded)
Players.PlayerRemoving:Connect(function(player)
	local profile = Profiles[player]
	if profile then profile:Release() end
end)
for _, p in ipairs(Players:GetPlayers()) do task.spawn(PlayerAdded, p) end