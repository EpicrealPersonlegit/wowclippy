local AvatarEditorService = game:GetService("AvatarEditorService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")

local Player = Players.LocalPlayer
local PlayerGui = Player:WaitForChild("PlayerGui")
local EquipEvent = ReplicatedStorage:WaitForChild("EquipAssetEvent")
local ChangeSkinColorEvent = ReplicatedStorage:WaitForChild("ChangeSkinColor")

local SearchBox, ResultsFrame, SkinHexBox

local function scanUI()
	for _, v in pairs(PlayerGui:GetDescendants()) do
		if v.Name == "Search" and v:IsA("TextBox") then SearchBox = v end
		if v.Name == "AvatarFrame" then ResultsFrame = v end
		if v.Name == "skinhex" and v:IsA("TextBox") then SkinHexBox = v end
	end
end

print("DEBUG: Waiting for UI...")
repeat scanUI(); task.wait(1) until SearchBox and ResultsFrame
print("DEBUG: UI Found! SearchBox: " .. SearchBox:GetFullName())

-- Ensure a Grid Layout exists so buttons aren't on top of each other
if not ResultsFrame:FindFirstChildOfClass("UIGridLayout") then
	local gl = Instance.new("UIGridLayout", ResultsFrame)
	gl.CellSize = UDim2.new(0, 90, 0, 90)
	gl.CellPadding = UDim2.new(0, 5, 0, 5)
end

local function performSearch()
	local text = SearchBox.Text
	if text == "" then return end
	print("DEBUG: User searched for: " .. text)
	
	for _, v in pairs(ResultsFrame:GetChildren()) do
		if v:IsA("ImageButton") then v:Destroy() end
	end

	local selectedTypes = {
		Enum.AvatarAssetType.Hat, Enum.AvatarAssetType.HairAccessory, 
		Enum.AvatarAssetType.Shirt, Enum.AvatarAssetType.Pants,
		Enum.AvatarAssetType.JacketAccessory, Enum.AvatarAssetType.SweaterAccessory,
		Enum.AvatarAssetType.ShoeAccessory, -- Corrected spelling
		Enum.AvatarAssetType.DynamicHead, Enum.AvatarAssetType.Torso,
		Enum.AvatarAssetType.LeftArm, Enum.AvatarAssetType.RightArm,
		Enum.AvatarAssetType.LeftLeg, Enum.AvatarAssetType.RightLeg
	}

	local params = CatalogSearchParams.new()
	params.SearchKeyword = text
	params.AssetTypes = selectedTypes

	local success, result = pcall(function() 
		return AvatarEditorService:SearchCatalog(params) 
	end)
	
	if success and result then
		local items = result:GetCurrentPage()
		print("DEBUG: Items found in Catalog: " .. #items)
		
		for _, item in pairs(items) do
			local btn = Instance.new("ImageButton")
			btn.Name = tostring(item.Id)
			btn.Size = UDim2.new(0, 90, 0, 90)
			btn.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
			btn.Image = "rbxthumb://type=Asset&id=" .. item.Id .. "&w=150&h=150"
			btn.ZIndex = 10 -- Ensure it's on top
			btn.Parent = ResultsFrame
			
			btn.MouseButton1Click:Connect(function()
				print("DEBUG: Fire Equip for " .. item.Id)
				EquipEvent:FireServer(item.Id, "Equip")
			end)
		end
	else
		warn("DEBUG: Catalog API Failed to fetch data.")
	end
end

-- Trigger search when pressing Enter
SearchBox.FocusLost:Connect(function(enterPressed)
	print("DEBUG: FocusLost fired. Enter: " .. tostring(enterPressed))
	performSearch() -- Search regardless of enter for testing
end)
