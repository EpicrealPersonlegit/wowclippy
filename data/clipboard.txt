local AvatarEditorService = game:GetService("AvatarEditorService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")

local Player = Players.LocalPlayer
local PlayerGui = Player:WaitForChild("PlayerGui")
local EquipEvent = ReplicatedStorage:WaitForChild("EquipAssetEvent")
local ChangeSkinColorEvent = ReplicatedStorage:WaitForChild("ChangeSkinColor")

-- [[ SEARCH & UI SETUP ]]
local function getUI()
    local avatar = PlayerGui:FindFirstChild("Avatar", true)
    if not avatar then return nil end
    
    return {
        Strings = avatar:FindFirstChild("Strings", true),
        Apply = avatar:FindFirstChild("Apply", true),
        ClearA = avatar:FindFirstChild("ClearA", true),
        skinhex = avatar:FindFirstChild("skinhex", true),
        Search = avatar:FindFirstChild("Search", true),
        AvatarFrame = avatar:FindFirstChild("AvatarFrame", true)
    }
}

local UI = getUI()
while not UI do task.wait(0.1) UI = getUI() end

-- [[ THE SEARCH ENGINE ]]
local function runSearch()
    local text = UI.Search.Text
    if text == "" then return end
    
    for _, child in pairs(UI.AvatarFrame:GetChildren()) do
        if child:IsA("ImageButton") then child:Destroy() end
    end

    local params = CatalogSearchParams.new()
    params.SearchKeyword = text
    
    local success, result = pcall(function() return AvatarEditorService:SearchCatalog(params) end)
    if success and result then
        if not UI.AvatarFrame:FindFirstChildOfClass("UIGridLayout") then
            local gl = Instance.new("UIGridLayout", UI.AvatarFrame)
            gl.CellSize = UDim2.new(0, 90, 0, 90)
        end
        for _, item in pairs(result:GetCurrentPage()) do
            local btn = Instance.new("ImageButton")
            btn.Size = UDim2.new(0, 90, 0, 90)
            btn.Image = "rbxthumb://type=Asset&id=" .. item.Id .. "&w=150&h=150"
            btn.Parent = UI.AvatarFrame
            btn.MouseButton1Click:Connect(function() EquipEvent:FireServer(item.Id, "Equip") end)
        end
    end
end

-- [[ SIDEBAR LOGIC ]]
UI.Apply.MouseButton1Click:Connect(function()
    local id = tonumber(UI.Strings.Text, 36)
    if id then EquipEvent:FireServer(id, "Equip") end
end)

UI.ClearA.MouseButton1Click:Connect(function()
    EquipEvent:FireServer(nil, "ClearAll")
end)

UI.skinhex.FocusLost:Connect(function()
    if UI.skinhex.Text ~= "" then ChangeSkinColorEvent:FireServer(UI.skinhex.Text) end
end)

UI.Search.FocusLost:Connect(function(enter) if enter then runSearch() end end)