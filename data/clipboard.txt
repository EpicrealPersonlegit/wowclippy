local AvatarEditorService = game:GetService("AvatarEditorService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")

local Player = Players.LocalPlayer
local PlayerGui = Player:WaitForChild("PlayerGui")
local EquipEvent = ReplicatedStorage:WaitForChild("EquipAssetEvent")

local SearchBox, ResultsFrame

local function scanUI()
	for _, v in pairs(PlayerGui:GetDescendants()) do
		if v.Name == "Search" and v:IsA("TextBox") then SearchBox = v end
		if v.Name == "AvatarFrame" then ResultsFrame = v end
	end
end

repeat scanUI(); task.wait(1) until SearchBox and ResultsFrame
print("DEBUG: UI Elements found and ready!")

local function performSearch()
	local text = SearchBox.Text
	if text == "" then return end
	print("DEBUG: Sending request for: " .. text)
	
	-- Clear results
	for _, v in pairs(ResultsFrame:GetChildren()) do
		if v:IsA("ImageButton") or v:IsA("UIGridLayout") then v:Destroy() end
	end
	
	-- Add layout so we can see them
	local layout = Instance.new("UIGridLayout", ResultsFrame)
	layout.CellSize = UDim2.new(0, 90, 0, 90)

	-- Search Params with ZERO extra settings to avoid Enum crashes
	local params = CatalogSearchParams.new()
	params.SearchKeyword = text

	-- The Actual Request
	local success, result = pcall(function() 
		return AvatarEditorService:SearchCatalog(params) 
	end)
	
	if success and result then
		local items = result:GetCurrentPage()
		print("DEBUG: Found " .. #items .. " items!") -- THIS MUST SHOW UP
		
		if #items == 0 then
			warn("DEBUG: The search returned 0 items. Try searching 'Red'.")
		end

		for _, item in pairs(items) do
			local btn = Instance.new("ImageButton")
			btn.Name = "Item_" .. item.Id
			btn.Size = UDim2.new(0, 90, 0, 90)
			btn.Image = "rbxthumb://type=Asset&id=" .. item.Id .. "&w=150&h=150"
			btn.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
			btn.Parent = ResultsFrame
			
			btn.MouseButton1Click:Connect(function()
				print("DEBUG: Equipping " .. item.Id)
				EquipEvent:FireServer(item.Id, "Equip")
			end)
		end
	else
		-- If it fails, this will tell us EXACTLY why
		warn("DEBUG ERROR: Search failed! Reason: " .. tostring(result))
	end
end

-- Force search on any focus loss
SearchBox.FocusLost:Connect(function()
	performSearch()
end)
